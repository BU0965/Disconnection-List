<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arrears Management System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background-color: #2c3e50;
            color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        #column-toggle {
            background-color: #9b59b6;
        }

        #column-toggle:hover {
            background-color: #8e44ad;
        }

        #back-to-dashboard {
            background-color: #e67e22;
        }

        #back-to-dashboard:hover {
            background-color: #d35400;
        }

        .filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }

        .filter-group label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .filter-actions {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .filter-actions button {
            height: 38px;
        }

        #apply-filter {
            background-color: #2ecc71;
        }

        #apply-filter:hover {
            background-color: #27ae60;
        }

        #clear-filter {
            background-color: #95a5a6;
        }

        #clear-filter:hover {
            background-color: #7f8c8d;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 10px 15px;
            background-color: #ecf0f1;
            border-radius: 4px;
            font-size: 14px;
            color: #7f8c8d;
        }

        .data-container {
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }

        th, td {
            border: 1px solid #e1e1e1;
            padding: 10px 12px;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        th {
            background-color: #34495e;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: 500;
            white-space: normal;
            word-wrap: break-word;
        }

        tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tbody tr:hover {
            background-color: #e8f4fd;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .pagination-btn {
            padding: 8px 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: #2980b9;
        }

        .pagination-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .page-numbers {
            display: flex;
            gap: 5px;
        }

        .page-number {
            padding: 8px 12px;
            background-color: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            cursor: pointer;
        }

        .page-number.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }

        .page-number:hover:not(.active) {
            background-color: #d5dbdb;
        }

        .rows-per-page {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }

        .rows-per-page select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: #2ecc71;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }

        .notification.error {
            background-color: #e74c3c;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 100;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 25px;
            width: 85%;
            max-width: 900px;
            border-radius: 8px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e1e1e1;
        }

        .modal-header h2 {
            color: #2c3e50;
            font-weight: 600;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #7f8c8d;
            transition: color 0.2s;
        }

        .close:hover {
            color: #e74c3c;
        }

        .column-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .column-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .column-item:hover {
            background-color: #f8f9fa;
        }

        .column-item input {
            margin: 0;
            transform: scale(1.2);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e1e1e1;
        }

        .modal-actions button {
            padding: 10px 20px;
        }

        #select-all {
            background-color: #2ecc71;
        }

        #select-all:hover {
            background-color: #27ae60;
        }

        #deselect-all {
            background-color: #e74c3c;
        }

        #deselect-all:hover {
            background-color: #c0392b;
        }

        #apply-columns {
            background-color: #3498db;
        }

        #apply-columns:hover {
            background-color: #2980b9;
        }

        .import-export-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .import-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #import-data {
            background-color: #2ecc71;
        }

        #import-data:hover {
            background-color: #27ae60;
        }

        #export-data {
            background-color: #e74c3c;
        }

        #export-data:hover {
            background-color: #c0392b;
        }

        .progress-container {
            width: 100%;
            background-color: #ecf0f1;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }

        .progress-bar {
            width: 0%;
            height: 20px;
            background-color: #3498db;
            border-radius: 4px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 500;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-selector select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .file-type-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-type-selector select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Arrears Management System</h1>
            <div class="controls">
                <button id="back-to-dashboard">Back to Dashboard</button>
                <button id="column-toggle">Toggle Columns</button>
            </div>
        </header>

        <div class="filter-section">
            <div class="filter-group">
                <label for="section-filter">Section</label>
                <select id="section-filter">
                    <option value="">All Sections</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="village-filter">Village</label>
                <select id="village-filter">
                    <option value="">All Villages</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="staff-filter">Staff</label>
                <select id="staff-filter">
                    <option value="">All Staff</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="subcategory-filter">Sub Category</label>
                <select id="subcategory-filter">
                    <option value="">All Sub Categories</option>
                    <option value="RCI+O">RCI+O</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="closing-balance-filter">Closing Balance ></label>
                <input type="number" id="closing-balance-filter" placeholder="Enter amount">
            </div>
            <div class="filter-group">
                <label for="age-filter">Age in Days ></label>
                <input type="number" id="age-filter" placeholder="Enter days">
            </div>
            <div class="filter-actions">
                <button id="apply-filter">Apply Filter</button>
                <button id="clear-filter">Clear Filter</button>
            </div>
        </div>

        <div class="status-bar">
            <span id="visible-columns-count">14 columns visible</span>
            <span id="total-rows-count">0 rows</span>
            <span id="import-status">Ready to import</span>
        </div>

        <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress-bar">0%</div>
        </div>

        <div class="data-container">
            <table id="data-table">
                <thead>
                    <tr id="table-header">
                        <!-- Headers will be generated dynamically -->
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Data will be populated here -->
                </tbody>
            </table>
        </div>

        <div class="pagination-container">
            <button id="first-page" class="pagination-btn">First</button>
            <button id="prev-page" class="pagination-btn">Previous</button>

            <div class="page-numbers" id="page-numbers">
                <!-- Page numbers will be generated here -->
            </div>

            <button id="next-page" class="pagination-btn">Next</button>
            <button id="last-page" class="pagination-btn">Last</button>

            <div class="rows-per-page">
                <label for="rows-per-page-select">Rows per page:</label>
                <select id="rows-per-page-select">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>

        <div class="import-export-container">
            <div class="import-controls">
                <div class="date-selector">
                    <select id="date-day">
                        <option value="">Day</option>
                        <!-- Days will be populated dynamically -->
                    </select>
                    <select id="date-month">
                        <option value="">Month</option>
                        <!-- Months will be populated dynamically -->
                    </select>
                    <select id="date-year">
                        <option value="">Year</option>
                        <!-- Years will be populated dynamically -->
                    </select>
                </div>
                <div class="file-type-selector">
                    <select id="file-type">
                        <option value="xlsx">XLSX</option>
                        <option value="xls">XLS</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
                <button id="import-data">Import Data from GitHub</button>
            </div>
            <button id="export-data">Export to Excel</button>
        </div>
    </div>

    <!-- Column Toggle Modal -->
    <div id="column-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select Columns to Display</h2>
                <span class="close">&times;</span>
            </div>
            <div class="column-list" id="column-list">
                <!-- Column checkboxes will be generated here -->
            </div>
            <div class="modal-actions">
                <button id="select-all">Select All</button>
                <button id="deselect-all">Deselect All</button>
                <button id="apply-columns">Apply Changes</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // Define all available columns
        const allColumns = [
            "Sr No",
            "PC",
            "DTC Code",
            "VC",
            "Section",
            "Village",
            "Staff",
            "Consumer No",
            "Name",
            "Sub Category",
            "Bill Due Date",
            "Last Receipt Date",
            "Bill Amount",
            "Current Receipt Amount",
            "Closing Balance",
            "Total Due Amount Including Current Bill",
            "Age in Days",
            "SD Adjusted Against Arrears",
            "Consumers Mobile Number",
            "TD/PD Date"
        ];

        // Define default visible columns
        let visibleColumns = [
            "Sr No",
            "PC",
            "DTC Code",
            "Section",
            "Consumer No",
            "Name",
            "Sub Category",
            "Bill Due Date",
            "Last Receipt Date",
            "Current Receipt Amount",
            "Closing Balance",
            "Total Due Amount Including Current Bill",
            "Age in Days",
            "TD/PD Date"
        ];

        // GitHub Repository URL
        const GITHUB_REPO_URL = "https://bu0965.github.io/Disconnection-List/";

        // Excel column mapping
        const excelColumnMapping = {
            "PC": 0,                    // Column A
            "DTC Code": 1,              // Column B
            "Consumer No": 6,           // Column G
            "Name": 7,                  // Column H
            "Sub Category": 8,          // Column I
            "Bill Due Date": 9,         // Column J
            "Last Receipt Date": 10,    // Column K
            "Bill Amount": 11,          // Column L
            "Current Receipt Amount": 12, // Column M
            "Closing Balance": 13,      // Column N
            "Total Due Amount Including Current Bill": 14, // Column O
            "Age in Days": 15,          // Column P
            "SD Adjusted Against Arrears": 16, // Column Q
            "Consumers Mobile Number": 17, // Column R
            "TD/PD Date": 18           // Column S
        };

        // VLOOKUP data storage
        let dbsLookupData = null;

        // Data storage for filters (even if columns are not visible)
        let allSectionData = [];
        let allVillageData = [];
        let allStaffData = [];
        let allSubCategoryData = [];

        // Store raw data for filtering
        let rawDataRows = [];

        // Pagination variables
        let currentPage = 1;
        let rowsPerPage = 10;
        let totalRows = 0;
        let allDataRows = [];
        let filteredDataRows = [];

        // Initialize date dropdowns
        function initializeDateDropdowns() {
            const daySelect = document.getElementById('date-day');
            const monthSelect = document.getElementById('date-month');
            const yearSelect = document.getElementById('date-year');

            // Populate days (1-31)
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = i.toString().padStart(2, '0');
                option.textContent = i.toString().padStart(2, '0');
                daySelect.appendChild(option);
            }

            // Populate months (1-12)
            const months = [
                { value: '01', name: 'January' },
                { value: '02', name: 'February' },
                { value: '03', name: 'March' },
                { value: '04', name: 'April' },
                { value: '05', name: 'May' },
                { value: '06', name: 'June' },
                { value: '07', name: 'July' },
                { value: '08', name: 'August' },
                { value: '09', name: 'September' },
                { value: '10', name: 'October' },
                { value: '11', name: 'November' },
                { value: '12', name: 'December' }
            ];

            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.name;
                monthSelect.appendChild(option);
            });

            // Populate years (2020 to current year + 1)
            const currentYear = new Date().getFullYear();
            for (let year = 2020; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year.toString();
                option.textContent = year.toString();
                yearSelect.appendChild(option);
            }

            // Set default to current date
            const today = new Date();
            daySelect.value = today.getDate().toString().padStart(2, '0');
            monthSelect.value = (today.getMonth() + 1).toString().padStart(2, '0');
            yearSelect.value = today.getFullYear().toString();
        }

        // Get selected date
        function getSelectedDate() {
            const day = document.getElementById('date-day').value;
            const month = document.getElementById('date-month').value;
            const year = document.getElementById('date-year').value;

            if (day && month && year) {
                return `${day}-${month}-${year}`;
            }
            return null;
        }

        // Get selected file type
        function getSelectedFileType() {
            return document.getElementById('file-type').value;
        }

        // Show notification
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = isError ? 'notification error' : 'notification';
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }

        // Update import status
        function updateImportStatus(message) {
            document.getElementById('import-status').textContent = message;
        }

        // Update progress bar
        function updateProgress(percentage, message = '') {
            const progressBar = document.getElementById('progress-bar');
            const progressContainer = document.getElementById('progress-container');

            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage}%${message ? ' - ' + message : ''}`;

            if (percentage > 0 && percentage < 100) {
                progressContainer.style.display = 'block';
            } else if (percentage === 100) {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 1000);
            }
        }

        // Show loading state
        function setLoadingState(loading) {
            const importButton = document.getElementById('import-data');
            const container = document.querySelector('.container');

            if (loading) {
                container.classList.add('loading');
                importButton.disabled = true;
                importButton.textContent = 'Importing...';
            } else {
                container.classList.remove('loading');
                importButton.disabled = false;
                importButton.textContent = 'Import Data from GitHub';
            }
        }

        // Update status bar
        function updateStatusBar() {
            const rowCount = filteredDataRows.length > 0 ? filteredDataRows.length : allDataRows.length;
            document.getElementById('visible-columns-count').textContent = `${visibleColumns.length} columns visible`;
            document.getElementById('total-rows-count').textContent = `${rowCount} rows`;

            const filterStatus = document.getElementById('import-status');
            if (filteredDataRows.length > 0 && filteredDataRows.length < allDataRows.length) {
                filterStatus.textContent = `${filteredDataRows.length} of ${allDataRows.length} rows after filtering`;
            } else if (allDataRows.length > 0) {
                filterStatus.textContent = `${allDataRows.length} rows loaded`;
            } else {
                filterStatus.textContent = 'Ready to import';
            }
        }

        // Initialize the table with headers
        function initializeTable() {
            const tableHeader = document.getElementById('table-header');
            tableHeader.innerHTML = '';

            // Add headers based on visible columns
            visibleColumns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column;
                th.dataset.column = column;
                tableHeader.appendChild(th);
            });

            updateStatusBar();
        }

        // Initialize column modal
        function initializeColumnModal() {
            const columnList = document.getElementById('column-list');
            columnList.innerHTML = '';

            allColumns.forEach(column => {
                const columnItem = document.createElement('div');
                columnItem.className = 'column-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `col-${column.replace(/\s+/g, '-')}`;
                checkbox.checked = visibleColumns.includes(column);
                checkbox.dataset.column = column;

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = column;

                columnItem.appendChild(checkbox);
                columnItem.appendChild(label);
                columnList.appendChild(columnItem);
            });
        }

        // Apply column visibility changes
        function applyColumnVisibility() {
            const checkboxes = document.querySelectorAll('#column-list input[type="checkbox"]');
            visibleColumns = [];

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    visibleColumns.push(checkbox.dataset.column);
                }
            });

            // Ensure at least one column is visible
            if (visibleColumns.length === 0) {
                visibleColumns = [allColumns[0]];
                showNotification('At least one column must be visible. Default column selected.', true);
            }

            initializeTable();

            // Recreate table rows if data exists
            if (allDataRows.length > 0) {
                createTableRowsFromData();
            }

            closeModal();
            showNotification('Column visibility updated successfully.');
        }

        // Apply filters to the table
        function applyFilters() {
            const sectionFilter = document.getElementById('section-filter').value;
            const villageFilter = document.getElementById('village-filter').value;
            const staffFilter = document.getElementById('staff-filter').value;
            const subCategoryFilter = document.getElementById('subcategory-filter').value;
            const closingBalanceFilter = document.getElementById('closing-balance-filter').value;
            const ageFilter = document.getElementById('age-filter').value;

            // Reset filtered data
            filteredDataRows = [];

            // If no filters are applied, show all data
            if (!sectionFilter && !villageFilter && !staffFilter && !subCategoryFilter &&
                !closingBalanceFilter && !ageFilter) {
                updateTableWithData(allDataRows);
                showNotification('All filters cleared. Showing all data.');
                return;
            }

            allDataRows.forEach((row, index) => {
                let showRow = true;

                // Get data from raw data storage (not from visible cells)
                const rawData = rawDataRows[index];
                if (!rawData) return;

                // Apply section filter
                if (sectionFilter && showRow) {
                    if (rawData.section !== sectionFilter) {
                        showRow = false;
                    }
                }

                // Apply village filter
                if (villageFilter && showRow) {
                    if (rawData.village !== villageFilter) {
                        showRow = false;
                    }
                }

                // Apply staff filter
                if (staffFilter && showRow) {
                    if (rawData.staff !== staffFilter) {
                        showRow = false;
                    }
                }

                // Apply sub category filter with special handling for RCI+O
                if (subCategoryFilter && showRow) {
                    if (subCategoryFilter === "RCI+O") {
                        // Show data for 1.Res, 2.Com, 3.Ind, and 8.Other categories
                        const validCategories = ["1.Res", "2.Com", "3.Ind", "8.Other"];
                        if (!validCategories.includes(rawData.subCategory)) {
                            showRow = false;
                        }
                    } else {
                        if (rawData.subCategory !== subCategoryFilter) {
                            showRow = false;
                        }
                    }
                }

                // Apply closing balance filter
                if (closingBalanceFilter && showRow) {
                    const balanceValue = parseFloat(rawData.closingBalance || 0);
                    if (balanceValue <= parseFloat(closingBalanceFilter)) {
                        showRow = false;
                    }
                }

                // Apply age filter
                if (ageFilter && showRow) {
                    const ageValue = parseFloat(rawData.age || 0);
                    if (ageValue <= parseFloat(ageFilter)) {
                        showRow = false;
                    }
                }

                // Add to filtered rows if it passes all filters
                if (showRow) {
                    filteredDataRows.push(row);
                }
            });

            // Update table with filtered data
            updateTableWithData(filteredDataRows);
            showNotification(`Filter applied. ${filteredDataRows.length} rows match your criteria.`);
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('section-filter').value = '';
            document.getElementById('village-filter').value = '';
            document.getElementById('staff-filter').value = '';
            document.getElementById('subcategory-filter').value = '';
            document.getElementById('closing-balance-filter').value = '';
            document.getElementById('age-filter').value = '';

            // Reset filtered data and show all data
            filteredDataRows = [];
            updateTableWithData(allDataRows);
            showNotification('Filters cleared. Showing all data.');
        }

        // Create table rows from data
        function createTableRowsFromData() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';

            allDataRows = [];

            // This function will be called after data is imported
            // The actual data processing happens in the import function
        }

        // Update table with data and apply pagination
        function updateTableWithData(dataRows) {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';

            totalRows = dataRows.length;

            // Calculate pagination
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, totalRows);

            // Add rows for current page with auto Sr No
            for (let i = startIndex; i < endIndex; i++) {
                if (dataRows[i]) {
                    const row = dataRows[i].cloneNode(true);

                    // Update Sr No if it's the first column
                    if (visibleColumns[0] === "Sr No") {
                        const srNoCell = row.cells[0];
                        if (srNoCell) {
                            srNoCell.textContent = i + 1; // Auto Sr No starting from 1
                        }
                    }

                    tableBody.appendChild(row);
                }
            }

            // Update pagination controls
            updatePagination();
            updateStatusBar();

            // Auto-adjust column widths based on content
            setTimeout(autoAdjustColumnWidths, 100);
        }

        // Auto-adjust column widths based on content
        function autoAdjustColumnWidths() {
            const table = document.getElementById('data-table');
            const headerCells = table.querySelectorAll('thead th');
            const bodyRows = table.querySelectorAll('tbody tr');

            // Reset all column widths
            headerCells.forEach(cell => {
                cell.style.width = 'auto';
            });

            // Calculate max width for each column
            headerCells.forEach((headerCell, colIndex) => {
                let maxWidth = headerCell.offsetWidth;

                bodyRows.forEach(row => {
                    const cell = row.cells[colIndex];
                    if (cell && cell.offsetWidth > maxWidth) {
                        maxWidth = cell.offsetWidth;
                    }
                });

                // Set the column width
                headerCell.style.width = `${maxWidth + 20}px`;
            });
        }

        // Update pagination controls
        function updatePagination() {
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            const pageNumbersContainer = document.getElementById('page-numbers');
            pageNumbersContainer.innerHTML = '';

            // Previous and First buttons
            document.getElementById('first-page').disabled = currentPage === 1;
            document.getElementById('prev-page').disabled = currentPage === 1;

            // Next and Last buttons
            document.getElementById('next-page').disabled = currentPage === totalPages || totalPages === 0;
            document.getElementById('last-page').disabled = currentPage === totalPages || totalPages === 0;

            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            // Adjust if we're near the end
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageNumber = document.createElement('div');
                pageNumber.className = `page-number ${i === currentPage ? 'active' : ''}`;
                pageNumber.textContent = i;
                pageNumber.addEventListener('click', () => {
                    currentPage = i;
                    const dataToShow = filteredDataRows.length > 0 ? filteredDataRows : allDataRows;
                    updateTableWithData(dataToShow);
                });
                pageNumbersContainer.appendChild(pageNumber);
            }

            // Update status
            const dataToShow = filteredDataRows.length > 0 ? filteredDataRows : allDataRows;
            document.getElementById('total-rows-count').textContent = `${dataToShow.length} rows${totalPages > 0 ? ` (Page ${currentPage} of ${totalPages})` : ''}`;
        }

        // Fetch file from GitHub repository
        async function fetchFileFromGitHub(filePath) {
            try {
                const fileUrl = `${GITHUB_REPO_URL}${filePath}`;
                console.log('Fetching file from:', fileUrl);

                const response = await fetch(fileUrl);
                if (!response.ok) {
                    throw new Error(`Failed to fetch file: ${response.status} ${response.statusText}`);
                }

                const arrayBuffer = await response.arrayBuffer();

                // Check if file is empty
                if (arrayBuffer.byteLength === 0) {
                    throw new Error('File is empty');
                }

                return arrayBuffer;
            } catch (error) {
                console.error('Error fetching file from GitHub:', error);
                throw error;
            }
        }

        // Load DBS lookup data
        async function loadDBSLookupData() {
            try {
                console.log('Loading DBS lookup data...');
                // Try different possible file names
                const possibleFiles = ['DBS.xlsx', 'DBS.csv', 'dbs.xlsx', 'dbs.csv'];
                let data = null;
                let lastError = null;

                for (const fileName of possibleFiles) {
                    try {
                        data = await fetchFileFromGitHub(fileName);
                        console.log(`Successfully loaded ${fileName}`);
                        break;
                    } catch (error) {
                        lastError = error;
                        console.warn(`Failed to load ${fileName}:`, error);
                        continue;
                    }
                }

                if (!data) {
                    console.warn('No DBS file found, continuing without lookup data');
                    return null;
                }

                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];

                // Get data from range A2:D250 as requested
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, range: 'A2:D250' });

                if (jsonData.length <= 1) {
                    console.warn('No data found in DBS file');
                    return null;
                }

                // Store the lookup data
                dbsLookupData = jsonData;
                console.log('DBS lookup data loaded successfully');
                return jsonData;
            } catch (error) {
                console.error('Error loading DBS lookup data:', error);
                return null;
            }
        }

        // VLOOKUP function with specified parameters
        function vlookup(lookupValue, colIndexNum) {
            if (!dbsLookupData || !lookupValue) return '';

            // Ensure string comparison
            const lookupStr = String(lookupValue).trim();

            for (let i = 0; i < dbsLookupData.length; i++) {
                const row = dbsLookupData[i];
                if (row && row[0] !== undefined) {
                    const rowValue = String(row[0]).trim();
                    if (rowValue === lookupStr) {
                        return row[colIndexNum - 1] || ''; // colIndexNum is 1-based, but array is 0-based
                    }
                }
            }
            return '';
        }

        // Import data from Excel file
        async function importDataFromGitHub() {
            try {
                // Get selected date and file type
                const datePart = getSelectedDate();
                const fileType = getSelectedFileType();

                if (!datePart) {
                    showNotification('Please select a valid date', true);
                    return;
                }

                const fileName = `${datePart}.${fileType}`;

                setLoadingState(true);
                updateProgress(0, 'Fetching data file from GitHub...');

                // Load DBS lookup data first, but continue even if it fails
                try {
                    updateProgress(10, 'Loading DBS lookup data...');
                    await loadDBSLookupData();
                } catch (dbsError) {
                    console.warn('DBS data load error, but continuing:', dbsError);
                    dbsLookupData = null;
                }

                updateProgress(20, 'Processing data file...');

                // Try different date formats and file types
                const possibleFileNames = [
                    fileName,
                    fileName.toLowerCase(),
                    fileName.replace(/-/g, '_'),
                    fileName.replace('.xlsx', '.csv'),
                    fileName.replace('.xls', '.csv'),
                    fileName.replace('.csv', '.xlsx')
                ];

                let data = null;
                let usedFileName = '';

                for (const name of possibleFileNames) {
                    try {
                        data = await fetchFileFromGitHub(name);
                        usedFileName = name;
                        console.log(`Successfully loaded ${name}`);
                        break;
                    } catch (error) {
                        console.warn(`Failed to load ${name}:`, error);
                        continue;
                    }
                }

                if (!data) {
                    throw new Error(`Could not find data file. Tried: ${possibleFileNames.join(', ')}`);
                }

                let jsonData;

                // Process different file types
                if (fileType === 'csv') {
                    // Convert CSV to string and then parse
                    const csvString = new TextDecoder().decode(data);
                    jsonData = XLSX.utils.sheet_to_json(
                        XLSX.utils.aoa_to_sheet(
                            csvString.split('\n').map(row => row.split(','))
                        ),
                        { header: 1 }
                    );
                } else {
                    // Process XLS or XLSX
                    const workbook = XLSX.read(data, { type: 'array' });

                    if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                        throw new Error('Excel file contains no sheets');
                    }

                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                }

                if (jsonData.length <= 1) {
                    showNotification('No data found in the file', true);
                    updateImportStatus('No data found');
                    setLoadingState(false);
                    return;
                }

                updateProgress(50, 'Processing data rows...');

                // Clear existing data
                allDataRows = [];
                filteredDataRows = [];
                rawDataRows = [];

                // Create data rows
                let rowCount = 0;
                let processedRows = 0;

                // Start from row 1 (index 1) since row 0 is header
                for (let i = 1; i < jsonData.length; i++) {
                    const rowData = jsonData[i];

                    // Skip empty rows
                    if (!rowData || rowData.length === 0 || !rowData.some(cell => cell !== null && cell !== '')) {
                        continue;
                    }

                    const row = document.createElement('tr');

                    // Store raw data for filtering (even if columns are not visible)
                    const rawData = {
                        section: '',
                        village: '',
                        staff: '',
                        subCategory: '',
                        closingBalance: 0,
                        age: 0
                    };

                    visibleColumns.forEach(column => {
                        const cell = document.createElement('td');
                        cell.dataset.column = column;

                        let cellValue = '';

                        try {
                            // Special handling for different columns
                            if (column === "VC") {
                                // Get first 5 characters from Consumer No
                                const consumerNo = rowData[excelColumnMapping["Consumer No"]] || '';
                                cellValue = String(consumerNo).substring(0, 5);
                            }
                            else if (column === "Section") {
                                // Use VLOOKUP from DBS data with VC as lookup value
                                const vcValue = String(rowData[excelColumnMapping["Consumer No"]] || '').substring(0, 5);
                                cellValue = vlookup(vcValue, 2); // col_index_num = 2 for Section
                                rawData.section = cellValue;
                            }
                            else if (column === "Village") {
                                // Use VLOOKUP from DBS data with VC as lookup value
                                const vcValue = String(rowData[excelColumnMapping["Consumer No"]] || '').substring(0, 5);
                                cellValue = vlookup(vcValue, 3); // col_index_num = 3 for Village
                                rawData.village = cellValue;
                            }
                            else if (column === "Staff") {
                                // Use VLOOKUP from DBS data with VC as lookup value
                                const vcValue = String(rowData[excelColumnMapping["Consumer No"]] || '').substring(0, 5);
                                cellValue = vlookup(vcValue, 4); // col_index_num = 4 for Staff
                                rawData.staff = cellValue;
                            }
                            else if (excelColumnMapping[column] !== undefined) {
                                // Direct mapping from Excel columns
                                cellValue = rowData[excelColumnMapping[column]] || '';

                                // Store raw data for filtering
                                if (column === "Sub Category") {
                                    rawData.subCategory = cellValue;
                                } else if (column === "Closing Balance") {
                                    rawData.closingBalance = cellValue;
                                } else if (column === "Age in Days") {
                                    rawData.age = cellValue;
                                }

                                // Format numeric values
                                if (["Bill Amount", "Current Receipt Amount", "Closing Balance",
                                     "Total Due Amount Including Current Bill", "SD Adjusted Against Arrears"].includes(column)) {
                                    if (typeof cellValue === 'number') {
                                        cellValue = "" + cellValue.toLocaleString('en-IN');
                                    } else if (cellValue && !isNaN(cellValue)) {
                                        cellValue = "" + parseFloat(cellValue).toLocaleString('en-IN');
                                    }
                                }

                                // Format dates
                                if (["Bill Due Date", "Last Receipt Date", "TD/PD Date"].includes(column) && cellValue) {
                                    if (typeof cellValue === 'number') {
                                        // Excel date serial number to JS date
                                        const excelDate = cellValue;
                                        const jsDate = new Date((excelDate - 25569) * 86400 * 1000);
                                        cellValue = jsDate.toLocaleDateString('en-IN');
                                    }
                                }
                            }
                        } catch (cellError) {
                            console.warn(`Error processing cell ${column}:`, cellError);
                            cellValue = '';
                        }

                        cell.textContent = cellValue;
                        row.appendChild(cell);
                    });

                    allDataRows.push(row);
                    rawDataRows.push(rawData);
                    rowCount++;
                    processedRows++;

                    // Update progress
                    if (processedRows % 10 === 0 || i === jsonData.length - 1) {
                        const progress = 50 + Math.round((processedRows / (jsonData.length - 1)) * 40);
                        updateProgress(progress, `Processed ${processedRows} rows`);
                    }
                }

                setLoadingState(false);
                updateProgress(100, 'Import complete');

                // Reset filtered data and update table with all data
                filteredDataRows = [];
                updateTableWithData(allDataRows);

                // Update filter dropdowns
                updateFilterDropdowns();

                showNotification(`Successfully imported ${rowCount} records from ${usedFileName}!`);
                updateImportStatus(`Imported ${rowCount} records from ${usedFileName}`);

                updateStatusBar();

            } catch (error) {
                console.error('Error importing data from GitHub:', error);
                showNotification('Error importing data: ' + error.message, true);
                updateImportStatus('Import failed');
                setLoadingState(false);
            }
        }

        // Update filter dropdowns with data from imported file
        function updateFilterDropdowns() {
            const sections = new Set();
            const villages = new Set();
            const staff = new Set();
            const subCategories = new Set();

            // Collect unique values from raw data (not from visible cells)
            rawDataRows.forEach(rawData => {
                if (rawData.section) sections.add(rawData.section);
                if (rawData.village) villages.add(rawData.village);
                if (rawData.staff) staff.add(rawData.staff);
                if (rawData.subCategory) subCategories.add(rawData.subCategory);
            });

            // Store all data for dynamic filtering
            allSectionData = Array.from(sections);
            allVillageData = Array.from(villages);
            allStaffData = Array.from(staff);
            allSubCategoryData = Array.from(subCategories);

            // Populate Section filter
            const sectionFilter = document.getElementById('section-filter');
            sectionFilter.innerHTML = '<option value="">All Sections</option>';
            allSectionData.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionFilter.appendChild(option);
            });

            // Populate Village filter
            const villageFilter = document.getElementById('village-filter');
            villageFilter.innerHTML = '<option value="">All Villages</option>';
            allVillageData.forEach(village => {
                const option = document.createElement('option');
                option.value = village;
                option.textContent = village;
                villageFilter.appendChild(option);
            });

            // Populate Staff filter
            const staffFilter = document.getElementById('staff-filter');
            staffFilter.innerHTML = '<option value="">All Staff</option>';
            allStaffData.forEach(staffMember => {
                const option = document.createElement('option');
                option.value = staffMember;
                option.textContent = staffMember;
                staffFilter.appendChild(option);
            });

            // Populate Sub Category filter
            const subCategoryFilter = document.getElementById('subcategory-filter');
            subCategoryFilter.innerHTML = '<option value="">All Sub Categories</option><option value="RCI+O">RCI+O</option>';
            allSubCategoryData.forEach(category => {
                if (category && category !== "RCI+O") {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    subCategoryFilter.appendChild(option);
                }
            });
        }

        // Update dependent filters based on section selection
        function updateDependentFilters() {
            const selectedSection = document.getElementById('section-filter').value;
            const villageFilter = document.getElementById('village-filter');
            const staffFilter = document.getElementById('staff-filter');

            // Reset village and staff filters
            villageFilter.innerHTML = '<option value="">All Villages</option>';
            staffFilter.innerHTML = '<option value="">All Staff</option>';

            if (!selectedSection) {
                // If no section selected, show all villages and staff
                allVillageData.forEach(village => {
                    const option = document.createElement('option');
                    option.value = village;
                    option.textContent = village;
                    villageFilter.appendChild(option);
                });

                allStaffData.forEach(staffMember => {
                    const option = document.createElement('option');
                    option.value = staffMember;
                    option.textContent = staffMember;
                    staffFilter.appendChild(option);
                });
                return;
            }

            // Filter villages and staff based on selected section
            const filteredVillages = new Set();
            const filteredStaff = new Set();

            rawDataRows.forEach(rawData => {
                if (rawData.section === selectedSection) {
                    if (rawData.village) filteredVillages.add(rawData.village);
                    if (rawData.staff) filteredStaff.add(rawData.staff);
                }
            });

            // Populate filtered villages
            filteredVillages.forEach(village => {
                const option = document.createElement('option');
                option.value = village;
                option.textContent = village;
                villageFilter.appendChild(option);
            });

            // Populate filtered staff
            filteredStaff.forEach(staffMember => {
                const option = document.createElement('option');
                option.value = staffMember;
                option.textContent = staffMember;
                staffFilter.appendChild(option);
            });
        }

        // Export data to Excel
        function exportToExcel() {
            try {
                // Check if there's data to export
                const dataToExport = filteredDataRows.length > 0 ? filteredDataRows : allDataRows;

                if (dataToExport.length === 0) {
                    showNotification('No data available to export', true);
                    return;
                }

                // Create workbook
                const wb = XLSX.utils.book_new();

                // Prepare data for export
                const exportData = [];

                // Add headers
                exportData.push(visibleColumns);

                // Add data rows
                dataToExport.forEach(row => {
                    const rowData = [];
                    const cells = row.querySelectorAll('td');

                    cells.forEach(cell => {
                        rowData.push(cell.textContent || '');
                    });

                    exportData.push(rowData);
                });

                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(exportData);

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Arrears Data');

                // Generate Excel file and trigger download
                const fileName = `arrears_data_export_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                showNotification('Data exported successfully!');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Error exporting data: ' + error.message, true);
            }
        }

        // Modal functions
        function openModal() {
            document.getElementById('column-modal').style.display = 'block';
            initializeColumnModal();
        }

        function closeModal() {
            document.getElementById('column-modal').style.display = 'none';
        }

        // Event listeners
        document.getElementById('column-toggle').addEventListener('click', openModal);
        document.getElementById('apply-columns').addEventListener('click', applyColumnVisibility);
        document.querySelector('.close').addEventListener('click', closeModal);

        document.getElementById('select-all').addEventListener('click', () => {
            document.querySelectorAll('#column-list input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
        });

        document.getElementById('deselect-all').addEventListener('click', () => {
            document.querySelectorAll('#column-list input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        });

        document.getElementById('export-data').addEventListener('click', exportToExcel);

        document.getElementById('import-data').addEventListener('click', () => {
            importDataFromGitHub();
        });

        document.getElementById('apply-filter').addEventListener('click', applyFilters);
        document.getElementById('clear-filter').addEventListener('click', clearFilters);

        // Section filter change listener for dependent filters
        document.getElementById('section-filter').addEventListener('change', updateDependentFilters);

        // Back to Dashboard button
        document.getElementById('back-to-dashboard').addEventListener('click', () => {
            // Replace with your actual dashboard URL
            window.location.href = 'https://bu0965.github.io/Disconnection-List/';
        });

        // Pagination event listeners
        document.getElementById('first-page').addEventListener('click', () => {
            currentPage = 1;
            const dataToShow = filteredDataRows.length > 0 ? filteredDataRows : allDataRows;
            updateTableWithData(dataToShow);
        });

        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                const dataToShow = filteredDataRows.length > 0 ? filteredDataRows : allDataRows;
                updateTableWithData(dataToShow);
            }
        });

        document.getElementById('next-page').addEventListener('click', () => {
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                const dataToShow = filteredDataRows.length > 0 ? filteredDataRows : allDataRows;
                updateTableWithData(dataToShow);
            }
        });

        document.getElementById('last-page').addEventListener('click', () => {
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            currentPage = totalPages;
            const dataToShow = filteredDataRows.length > 0 ? filteredDataRows : allDataRows;
            updateTableWithData(dataToShow);
        });

        // Rows per page change listener
        document.getElementById('rows-per-page-select').addEventListener('change', (e) => {
            rowsPerPage = parseInt(e.target.value);
            currentPage = 1;
            const dataToShow = filteredDataRows.length > 0 ? filteredDataRows : allDataRows;
            updateTableWithData(dataToShow);
        });

        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('column-modal');
            if (event.target === modal) {
                closeModal();
            }
        });

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            initializeTable();
            initializeDateDropdowns();
            createTableRowsFromData();

            // Debug help
            console.log('Arrears Management System initialized');
            console.log('Available columns:', allColumns);
            console.log('Visible columns:', visibleColumns);
            console.log('GitHub Repo URL:', GITHUB_REPO_URL);
        });
    </script>
</body>
</html>